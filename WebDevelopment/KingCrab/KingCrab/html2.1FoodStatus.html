<!DOCTYPE html>
<html lang="en">
  
  <head>
    <script src="inputFieldFunctions.js"></script>
    <link rel="stylesheet" href="stylesheet2.css" />
    <title>Page Title</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
   
  </head>
  <body>
    <div class="header">
      <h1>Waiter</h1>
    </div>

    <div class="navbar">
      <a href="html2.0FoodOrder.html" class="hover">Food Order</a>
      <a href="html2.1FoodStatus.html" class="active">Food Status</a>
      <a href="html2.2FoodServe.html" class="hover">Food Serve</a>
      <a href="htmlLogin.html" class="right">Logout</a>


    </div>

    <div class="main"> 
      <h2>Table</h2>
      <table class="centerflex" id="table"></table>
    </div>

    <div class="footer">
      <h2>King Crab Restaurant</h2>
    </div>
  </body>
</html>
<script>

  var table = document.getElementById("table");
  var thead, tr, td;
  table.appendChild((thead = document.createElement("thead")));
  thead.appendChild((tr = document.createElement("tr")));
  tr.appendChild((td = document.createElement("td")));
  td.innerHTML = "<center><b>Customer Name: </center>";
  tr.appendChild((td = document.createElement("td")));
  td.innerHTML = "<center><b>Table Number: </center>";
  tr.appendChild((td = document.createElement("td")));
  td.innerHTML = "<center><b>Food Name: </center>";
  tr.appendChild((td = document.createElement("td")));
  td.innerHTML = "<center><b>Food Quantity</center>";
  tr.appendChild((td = document.createElement("td")));
  td.innerHTML = "<center><b>Food Status</center>";
  tr.appendChild((td = document.createElement("td")));
  td.innerHTML = "<center><b>Serving Status</center>";
  tr.appendChild((td = document.createElement("td")));
  td.innerHTML = "<center><b>Cancellation</center>";



  var WaiterIDS = sessionStorage.getItem("ID");
  var httpRequest;
  var start = 0;
  //   document.getElementById("request").addEventListener("click", makeRequest);
  var httpRequest = new XMLHttpRequest();
  httpRequest.onreadystatechange = function () {
    if (httpRequest.readyState === httpRequest.DONE) {
      if (httpRequest.status === 200) {
        //alert(httpRequest.responseText);
        var rows = document.getElementById("table").rows.length;
        var rows = document.getElementById("table").rows.length;
        
        if(rows > 2 ){
            for (let i = rows; i > 1; i--){
                document.getElementById("table").deleteRow(i-1);
            }
        }
        myObj = JSON.parse(httpRequest.responseText);
        for (var key of Object.keys(myObj)) {
          tr = document.createElement("tr");
          tr.setAttribute("id", "row" + key);
          // if (key % 2 == 0) {
          //   tr.setAttribute("style", "background:white");
          // }
          var DB_WID = myObj[key].WaiterID;
          var LoginID = sessionStorage.getItem("ID");
          if(DB_WID == LoginID){
            table.appendChild(tr);
            tr.appendChild((td = document.createElement("td")));
            td.innerHTML = myObj[key].Customer;
            tr.appendChild((td = document.createElement("td")));
            td.innerHTML = myObj[key].TableNumber;
            tr.appendChild((td = document.createElement("td")));
            td.innerHTML = myObj[key].Dish;
            tr.appendChild((td = document.createElement("td")));
            td.innerHTML = myObj[key].DishQuantity;
            tr.appendChild((td = document.createElement("td")));
            td.innerHTML = myObj[key].PickupStatus;
          }
          //#region Edit this form database
          

          //-------------------------------------------------//
          
          tr.appendChild((td = document.createElement("td")));
          var btn = document.createElement("input");
          btn.type = "button";
          btn.className = "btn";
          btn.value = myObj[key].PickupStatus;
          var statuses = btn.value;
          
          if(myObj[key].DishStatus != 2){
              btn.disabled = true;
          }
          else{
            if(myObj[key].PickupStatus == 1){
              // btn.setAttribute('disabled', '');
              //btn.disabled = true;
              btn.value = "In Process";
              }

              if(myObj[key].PickupStatus == 2){
                // btn.setAttribute('disabled', '');
                btn.value = "Complete";
                btn.disabled = true;
              }
          }
          var ReservationID = myObj[key].RD_ID;
          btn.onclick = (function (key) {
            return function () {
              updateStatus(key);
              if(myObj[key].PickupStatus == 1){
                //alert(ReservationID + " " + WaiterIDS + " " + key);

                confirmBilling(ReservationID, WaiterIDS, key);

                billing();

                if(myObj[key].BillingStatus == 0){
                billingStatus(key,myObj[key].CustomerQuantity,WaiterID);
                }
              }
              document.location.reload();
            };
          })(key);
          td.appendChild(btn);

          //-------------------------------------------------//

          tr.appendChild((td = document.createElement("td")));
          var btn2 = document.createElement("input");
          btn2.type = "button";
          btn2.className = "btn";
          btn2.value = "Cancel";
          if(statuses != '1'){
            // btn.setAttribute('disabled', '');
            btn2.disabled = true;
          }

          btn2.onclick = (function (key) {
            return function () {
              removeStatus(key);
              document.location.reload();
            };
          })(key);
          td.appendChild(btn2);

          //-------------------------------------------------//

         //#endregion Edit this form database

         
        }
      } else {
        alert("Something's wrong here!");
      }
    }
    // table.setAttribute("class", "myId");
  }

  function updateStatus(key) {
    httpRequest.open(
      "get",
      "GetTableDataPickup.php?Table=viewFoodOrderDetail&updateID="+key
    );
    httpRequest.send();
  }

  function removeStatus(key) {
    //alert(key);
    httpRequest.open("get", "PHP2.1RemovePickupStatus.php?Table=viewFoodOrderDetail&updateID="+key);
    httpRequest.send();
    document.location.reload()
  }


  httpRequest.open("get", "GetTableDataPickup.php?Table=viewFoodOrderDetail&updateID="+0);
  httpRequest.send();

  function confirmBilling(ReservationID,WaiterIDS,key){
    //alert(ReservationID+" "+WaiterIDS+" "+key);
    httpRequest.open("get", "PHP2.1CustomerBilling.php?Table=viewFoodOrderDetail&updateID="+ReservationID+"&ED_ID="+WaiterIDS+"&FO_ID="+key);
    httpRequest.send();
  }

function billing(){
  var httpRequest = new XMLHttpRequest();
  httpRequest.onreadystatechange = function () {
    if (httpRequest.readyState === httpRequest.DONE) {
      if (httpRequest.status === 200) {
        myObj = JSON.parse(httpRequest.responseText);
        for (var key of Object.keys(myObj)) {
          if(myObj[key].BillingStatus == 0){
                billingStatus(key,myObj[key].CustomerQuantity,WaiterIDS);
              }
        }
      }
    }
  }
  httpRequest.open("get", "GetTableDataCheckout.php?Table=viewCustomerOrderDetail&updateID=0");
  httpRequest.send();
}

function billingStatus(key,CQ,WaiterID){
    httpRequest.open("get", "PHP2.2FoodServe.php?Table=viewFoodOrderDetail&updateID="+key+"&ED_ID="+CQ+"&FO_ID="+WaiterID);
    httpRequest.send();
  }
</script>